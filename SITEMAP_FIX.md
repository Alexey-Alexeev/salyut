# Решение проблемы с sitemap.xml и .htaccess

## Проблемы

### 1. Конфликт sitemap.xml
При статическом экспорте Next.js (`output: 'export'`) происходил конфликт:
- В `public/sitemap.xml` находится детальный sitemap с video и image разметкой
- Next.js 13+ автоматически генерирует свой упрощенный `sitemap.xml` при сборке
- Автогенерированный sitemap **перезаписывал** детальный файл в директории `out/`

### 2. Блокировка sitemap.xml на рег.ру (403 Forbidden)
На хостинге рег.ру при обращении к `https://salutgrad.ru/sitemap.xml` выдавалась ошибка **403 Forbidden**, потому что:
- В `public/.htaccess` было правило, блокирующее **все .xml файлы**
- `.htaccess` не копировался автоматически в `out/` при сборке
- На Vercel проблемы не было (там не используется Apache/.htaccess)

## Решение

Реализованы следующие изменения:

### 1. Исправлен .htaccess
**Файл:** `public/.htaccess`

**Было:**
```apache
<FilesMatch "(\.(env|git|htaccess|xml|json|lock|config|log|sh|sql))$">
    Order allow,deny
    Deny from all
</FilesMatch>
```
☝️ Это правило блокировало **все .xml файлы**, включая sitemap.xml

**Стало:**
```apache
# Разрешаем доступ к важным SEO-файлам
<FilesMatch "^(sitemap\.xml|robots\.txt)$">
    Require all granted
</FilesMatch>

# Запрещаем доступ к системным файлам (НЕ включая sitemap.xml)
<FilesMatch "(\.(env|git|htaccess|json|lock|config|log|sh|sql))$">
    Require all denied
</FilesMatch>
```
✅ Теперь sitemap.xml и robots.txt явно разрешены

### 2. Обновлен скрипт копирования
**Файл:** `scripts/copy-sitemap.js`

Скрипт автоматически копирует после сборки:
1. `sitemap.xml` - детальный sitemap с video/image разметкой (перезаписывает упрощенный от Next.js)
2. `.htaccess` - правила Apache для рег.ру хостинга

### 3. Обновлен build-процесс
**Файл:** `package.json`

```json
"build": "next build && node scripts/copy-sitemap.js"
```

Теперь после каждой сборки автоматически запускается копирование правильного sitemap.

### 4. Создан app/sitemap.ts
**Файл:** `app/sitemap.ts`

Возвращает пустой массив, чтобы минимизировать размер автогенерированного sitemap (который все равно будет перезаписан).

## Использование

### Обычная сборка
```bash
npm run build
```
Скрипт копирования запустится автоматически после сборки.

### Ручное копирование (если нужно)
```bash
npm run copy-sitemap
```

## Деплой

### На рег.ру (основной хостинг)
После загрузки новой сборки на рег.ру убедитесь, что загружены:
- Все файлы из директории `out/`
- **Обязательно**: `out/.htaccess` (скрытый файл!)
- **Обязательно**: `out/sitemap.xml`

⚠️ **Важно**: При загрузке через FTP-клиент не забудьте включить отображение скрытых файлов, чтобы видеть `.htaccess`

### На Vercel (тестовый)
Деплой происходит автоматически через Git. `.htaccess` игнорируется (Vercel не использует Apache).

### Проверка после деплоя
После деплоя новой сборки проверьте:
1. ✅ https://salutgrad.ru/sitemap.xml - должен **открываться** (не 403!)
2. ✅ Файл должен содержать ~56 KB данных
3. ✅ Должны присутствовать namespaces: `xmlns:image`, `xmlns:video`, `xmlns:mobile`, `xmlns:xhtml`
4. ✅ Детальные метаданные для каждого товара (video, image теги)

## Проверка локально

```bash
# Сборка
npm run build

# Проверка содержимого
head -20 out/sitemap.xml

# Должны увидеть:
# - xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"
# - xmlns:video="http://www.google.com/schemas/sitemap-video/1.1"
# - Комментарии на русском языке
# - Детальные метаданные для каждой страницы
```

## Важно

### Для sitemap.xml
- **Не удаляйте** `public/sitemap.xml` - это источник правильного sitemap
- **Не редактируйте** `out/sitemap.xml` вручную - он перезаписывается при каждой сборке
- Все изменения sitemap делайте в `public/sitemap.xml`

### Для .htaccess
- **Не удаляйте** `public/.htaccess` - это конфигурация для рег.ру хостинга
- **Не редактируйте** `out/.htaccess` вручную - он перезаписывается при каждой сборке
- Все изменения .htaccess делайте в `public/.htaccess`
- Правила из `public/.htaccess` НЕ влияют на локальную разработку (только на Apache/рег.ру)

### После изменений
После обновления `public/sitemap.xml` или `public/.htaccess` пересоберите проект:
```bash
npm run build
```

## Преимущества решения

✅ Сохранены все SEO-метаданные (video, image tags)  
✅ Исправлена ошибка 403 на рег.ру - sitemap.xml теперь доступен  
✅ Автоматизация - не требуется ручное копирование файлов  
✅ Совместимость со статическим экспортом Next.js  
✅ Простота поддержки - правки в одном месте (public/)  
✅ Работает на обоих хостингах (рег.ру и Vercel)  

## Альтернативные решения (не использованы)

1. **Динамическая генерация sitemap.ts** - сложно поддерживать video/image теги программно
2. **Переименование файла** - нарушит стандартные пути (/sitemap.xml)
3. **Отключение статического экспорта** - противоречит требованию проекта

