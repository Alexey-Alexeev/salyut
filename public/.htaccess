# ===============================
# üåê –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ===============================
RewriteEngine On
Options -Indexes

# ===============================
# üß≠ Favicon —Ä–µ–¥–∏—Ä–µ–∫—Ç (–ü–ï–†–í–´–ú!)
# ===============================
RewriteRule ^icons/favicon\.ico$ /favicon.ico [L,R=301]

# ===============================
# üîê –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π HTTPS
# ===============================
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

# ===============================
# üåç –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–º–µ–Ω
# ===============================
# –†–µ–¥–∏—Ä–µ–∫—Ç —Å www –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
RewriteCond %{HTTP_HOST} ^www\.salutgrad\.ru$ [NC]
RewriteRule ^(.*)$ https://salutgrad.ru/$1 [L,R=301]

# –†–µ–¥–∏—Ä–µ–∫—Ç —Å –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–º–µ–Ω–∞
RewriteCond %{HTTP_HOST} ^—Å–∞–ª—é—Ç–≥—Ä–∞–¥\.—Ä—Ñ$ [NC,OR]
RewriteCond %{HTTP_HOST} ^www\.—Å–∞–ª—é—Ç–≥—Ä–∞–¥\.—Ä—Ñ$ [NC]
RewriteRule ^(.*)$ https://salutgrad.ru/$1 [L,R=301]

# ===============================
# üîÑ SPA fallback (Next.js static export)
# ===============================
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]

# ===============================
# ‚öôÔ∏è –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
# ===============================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"

    # –î–æ–ª–≥–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|svg|ico|webp|woff|woff2|ttf|eot)$">
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>
</IfModule>

# ===============================
# üí® Gzip / Brotli —Å–∂–∞—Ç–∏–µ
# ===============================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
</IfModule>

# ===============================
# üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ SEO
# ===============================
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# ===============================
# üéØ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ iframe –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ===============================
<IfModule mod_headers.c>
    # –†–∞–∑—Ä–µ—à–∞–µ–º iframe –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∏
    SetEnvIf Referer "^https?://([^/]+\.)?(metrika\.yandex\.(ru|by)|metrica\.yandex\.(com|com\.tr)|webvisor\.com)/" allow_yandex

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º X-Frame-Options —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞
    Header set X-Frame-Options "SAMEORIGIN" env=!allow_yandex

    # Content-Security-Policy –¥–ª—è iframe
    Header set Content-Security-Policy "frame-ancestors 'self' https://metrika.yandex.ru https://metrika.yandex.by https://metrica.yandex.com https://metrica.yandex.com.tr https://webvisor.com https://*.webvisor.com"
</IfModule>

# ===============================
# üìÅ –î–æ—Å—Ç—É–ø –∫ –≤–∞–∂–Ω—ã–º SEO-—Ñ–∞–π–ª–∞–º
# ===============================
<FilesMatch "^(sitemap\.xml|robots\.txt)$">
    Require all granted
</FilesMatch>

# ===============================
# üö´ –ó–∞—â–∏—Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ===============================
<FilesMatch "(\.(env|git|htaccess|json|lock|config|log|sh|sql))$">
    Require all denied
</FilesMatch>

# ===============================
# üîê HSTS
# ===============================
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>
