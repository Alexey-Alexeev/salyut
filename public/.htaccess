# ===============================
# üåê –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ===============================
RewriteEngine On
Options -Indexes

# –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
RewriteCond %{HTTP_HOST} ^(www\.)?salutgrad\.ru$ [NC,OR]
RewriteCond %{HTTP_HOST} ^—Å–∞–ª—é—Ç–≥—Ä–∞–¥\.—Ä—Ñ$ [NC]
RewriteRule ^ - [L]

# –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω
RewriteRule ^(.*)$ https://salutgrad.ru/$1 [L,R=301]

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

# ===============================
# üîÑ SPA fallback (Next.js static export)
# ===============================

# Favicon —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –∫–æ—Ä–Ω–µ /favicon.ico
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]

# ===============================
# ‚öôÔ∏è –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
# ===============================
<IfModule mod_expires.c>
    ExpiresActive On

    # HTML ‚Äî –∫–æ—Ä–æ—Ç–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    <FilesMatch "\.html?$">
        ExpiresDefault "access plus 20 minutes"
        Header set Cache-Control "public, max-age=1200, must-revalidate"
    </FilesMatch>

    # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —à—Ä–∏—Ñ—Ç—ã, —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|svg|ico|webp|woff|woff2|ttf|eot)$">
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>

    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî 1 —á–∞—Å
    ExpiresDefault "access plus 1 hour"
</IfModule>

# ===============================
# üí® Gzip / Brotli —Å–∂–∞—Ç–∏–µ
# ===============================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
</IfModule>

# ===============================
# üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ SEO
# ===============================
<IfModule mod_headers.c>
    # –ó–∞—â–∏—Ç–∞ –æ—Ç MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
    Header always set X-XSS-Protection "1; mode=block"

    # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ Referer
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # HSTS ‚Äî –∑–∞—Å—Ç–∞–≤–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # üéØ –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞ ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º iframe
    SetEnvIf Referer "^https?://([^/]+\.)?(metrika\.yandex\.(ru|by)|metrica\.yandex\.(com|com\.tr)|webvisor\.com)/" allow_yandex
    Header set X-Frame-Options "SAMEORIGIN" env=!allow_yandex
    Header set Content-Security-Policy "frame-ancestors 'self' https://metrika.yandex.ru https://metrika.yandex.by https://metrica.yandex.com https://metrica.yandex.com.tr https://webvisor.com https://*.webvisor.com"
</IfModule>

# ===============================
# üîí –î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
# ===============================

# –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ SEO-—Ñ–∞–π–ª–∞–º
<FilesMatch "^(sitemap\.xml|robots\.txt)$">
    Require all granted
</FilesMatch>

# –ó–∞–ø—Ä–µ—â–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º
<FilesMatch "(\.(env|git|htaccess|json|lock|config|log|sh|sql))$">
    Require all denied
</FilesMatch>