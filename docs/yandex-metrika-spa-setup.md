# Настройка Яндекс.Метрики для SPA-сайта

## Что было сделано

### 1. Обновлен компонент YandexMetrika (`components/yandex-metrika.tsx`)

Реализована корректная отправка событий просмотра страниц согласно официальной документации Яндекс Метрики для SPA-сайтов.

#### Ключевые изменения:

1. **Упрощена логика инициализации**
   - Удалены избыточные проверки и задержки
   - Добавлено надежное ожидание готовности счетчика (до 5 секунд)
   - Добавлено подробное логирование для отладки

2. **Исправлена отправка первого hit**
   - Первый hit отправляется после того, как счетчик полностью инициализирован
   - Используется правильный формат URL (абсолютный)
   - Передается корректный title страницы

3. **Улучшена отправка hit при SPA-переходах**
   - Hit отправляется при каждом изменении URL
   - Передается referer (предыдущая страница) для корректного отслеживания навигации
   - Защита от дублирования hit при повторных рендерах

4. **Добавлено логирование**
   - В production: логи отправки hit в консоли браузера
   - В development: логи без реальной отправки данных

### 2. Обновлена библиотека метрики (`lib/metrika.ts`)

Добавлена функция `sendMetrikaHit()` для ручной отправки событий просмотра страниц.

## Проверка работы

### 1. Проверка в локальной разработке

1. Запустите проект локально:
   ```bash
   npm run dev
   ```

2. Откройте консоль браузера (F12)

3. При навигации по сайту вы должны видеть логи:
   ```
   [Metrika DEV] Page view: /catalog
   [Metrika DEV] Page view: /product/123
   ```

### 2. Проверка на production

После деплоя на `salutgrad.ru`:

1. Откройте сайт в браузере

2. Откройте консоль браузера (F12)

3. Обновите страницу и проверьте логи:
   ```
   [Metrika] Script loaded
   [Metrika] Counter ready after 200 ms
   [Metrika] Hit sent: {
     url: "https://salutgrad.ru/",
     title: "Главная страница",
     isInitialHit: true
   }
   ```

4. Перейдите на другую страницу (например, каталог):
   ```
   [Metrika] URL changed: / -> /catalog
   [Metrika] Hit sent: {
     url: "https://salutgrad.ru/catalog",
     title: "Каталог",
     referer: "https://salutgrad.ru/",
     isInitialHit: false
   }
   ```

### 3. Проверка в Яндекс.Метрике

1. Зайдите в [Яндекс.Метрику](https://metrika.yandex.ru/)

2. Перейдите в свой счетчик (ID: 104700931)

3. Откройте раздел **"Отчеты" → "Стандартные отчеты" → "Посещаемость" → "Просмотры"**
   - Вы должны увидеть увеличение количества просмотров страниц

4. Откройте раздел **"Вебвизор"**
   - После накопления данных (обычно 1-2 часа) появятся записи сеансов
   - Вы сможете просматривать записи действий пользователей на сайте

5. Проверьте раздел **"Отчеты" → "Источники" → "Сводка"**
   - Должны корректно отслеживаться источники трафика
   - Внутренние переходы должны показывать правильный referer

## Техническая информация

### Параметры инициализации счетчика

```javascript
ym(104700931, 'init', {
  defer: true,              // Отключает автоматическую отправку hit
  clickmap: true,           // Карта кликов
  trackLinks: true,         // Отслеживание внешних ссылок
  accurateTrackBounce: true,// Точный показатель отказов
  webvisor: true,           // Вебвизор
  ecommerce: "dataLayer",   // Электронная торговля
  trackHash: false          // Не отслеживать hash в URL
})
```

### Метод hit

Согласно [официальной документации](https://yandex.ru/support/metrica/code/counter-spa-setup.html), метод `hit` используется для отправки данных о просмотре страницы:

```javascript
ym(counterId, 'hit', url, {
  title: document.title,    // Заголовок страницы
  referer: previousUrl,     // URL предыдущей страницы
  params: {                 // Дополнительные параметры (опционально)
    order_price: 1000,
    currency: 'RUB'
  }
});
```

### Когда отправляется hit

1. **Первая загрузка страницы**
   - После полной инициализации счетчика
   - Без referer (берется из document.referrer автоматически)

2. **SPA-переходы**
   - При каждом изменении URL (pathname или query параметры)
   - С referer (предыдущая страница на сайте)
   - С актуальным title страницы

## Troubleshooting

### Hit не отправляются

1. **Проверьте консоль браузера**
   - Должны быть логи `[Metrika] Hit sent:`
   - Если есть ошибки - проверьте текст ошибки

2. **Проверьте Network в DevTools**
   - Откройте вкладку Network в консоли
   - Фильтр по домену `mc.yandex.ru`
   - Должны быть запросы к `https://mc.yandex.ru/watch/...`

3. **Проверьте блокировщики рекламы**
   - Отключите AdBlock и аналоги
   - Некоторые расширения блокируют счетчики метрики

### Вебвизор не работает

1. **Подождите накопления данных**
   - Данные появляются не моментально
   - Обычно через 1-2 часа после первых посещений

2. **Проверьте настройки Вебвизора**
   - Метрика → Настройки → Вебвизор
   - Убедитесь, что Вебвизор включен

3. **Проверьте количество визитов**
   - Вебвизор записывает только часть визитов (сэмплирование)
   - При малом трафике записей может быть мало

## Дополнительные возможности

### Ручная отправка hit

Если нужно вручную отправить hit (например, после AJAX-загрузки контента):

```typescript
import { sendMetrikaHit } from '@/lib/metrika';

// Отправка hit для текущей страницы
sendMetrikaHit();

// Отправка hit для конкретного URL
sendMetrikaHit('/virtual-page', {
  title: 'Виртуальная страница',
  referer: '/previous-page'
});
```

### Отправка целей

Для отслеживания важных действий пользователей:

```typescript
import { sendMetrikaGoal } from '@/lib/metrika';

// Простая цель
sendMetrikaGoal('button_click');

// Цель с параметрами
sendMetrikaGoal('order_success', {
  order_price: 5000,
  currency: 'RUB'
});
```

## Связанные файлы

- `components/yandex-metrika.tsx` - основной компонент метрики
- `lib/metrika.ts` - утилиты для работы с метрикой
- `app/layout.tsx` - подключение компонента YandexMetrika
- `YANDEX_METRIKA_GOALS_SETUP.md` - настройка целей

## Полезные ссылки

- [Установка счетчика для SPA](https://yandex.ru/support/metrica/code/counter-spa-setup.html)
- [Метод hit](https://yandex.ru/support/metrica/objects/hit.html)
- [Метод reachGoal](https://yandex.ru/support/metrica/objects/reachgoal.html)
- [Вебвизор](https://yandex.ru/support/metrica/general/webvisor.html)

